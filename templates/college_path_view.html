<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Your College Planning Path â€“ Mentics</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Lalezar&display=swap"
        rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <style>
        .font-lalezar {
            font-family: 'Lalezar', cursive;
        }

        .font-sans {
            font-family: 'Inter', sans-serif;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at 10% 20%, rgba(147, 197, 253, 0.2), transparent 40%),
                radial-gradient(circle at 80% 90%, rgba(99, 102, 241, 0.2), transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(199, 210, 254, 0.1), transparent 50%);
            animation: aurora 20s infinite linear;
            z-index: -1;
        }

        @keyframes aurora {
            0% {
                transform: rotate(0deg) scale(1.2);
            }

            50% {
                transform: rotate(180deg) scale(1.5);
            }

            100% {
                transform: rotate(360deg) scale(1.2);
            }
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.4);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.6);
        }

        #chat-history {
            scroll-behavior: smooth;
        }

        .task-node {
            transform: scale(0);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
        }

        .task-node.visible {
            transform: scale(1);
            opacity: 1;
        }

        .dash-segment {
            opacity: 0;
        }

        .dash-segment.animate-in {
            animation: pop-in 0.2s ease forwards;
        }

        @keyframes pop-in {
            from {
                opacity: 0;
                transform: scale(0.5);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>

<body class="bg-[#F8F7FF] font-sans text-slate-800 antialiased">
    <div class="flex h-screen">
        <aside
            class="w-64 flex-shrink-0 bg-white/60 backdrop-blur-xl border-r border-white/20 p-6 flex-col hidden md:flex">
            <a href="/" class="text-3xl font-bold text-purple-600 tracking-tight font-lalezar mb-12">
                MENTICS
            </a>
            <nav class="flex flex-col space-y-2">
                <a href="/dashboard"
                    class="flex items-center gap-3 px-4 py-2 text-slate-600 font-semibold rounded-lg hover:bg-purple-50 hover:text-purple-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path
                            d="M11.25 4.533A9.707 9.707 0 0 0 6 3a9.735 9.735 0 0 0-3.25.555.75.75 0 0 0-.5.707v14.522c0 .318.22.6.5.707a9.735 9.735 0 0 0 3.25.555 9.707 9.707 0 0 0 5.25-1.533v-1.37a.75.75 0 0 0-.56-0.723c-1.428-.344-2.285-.945-2.285-1.717s.857-1.373 2.285-1.717a.75.75 0 0 0 .56-.723v-1.37c0-.629-.444-1.21-1.141-1.423-1.02-.3-1.859-.933-1.859-1.828s.839-1.528 1.859-1.828c.697-.213 1.141-.794 1.141-1.423v-1.37ZM18 3a9.735 9.735 0 0 0-3.25.555.75.75 0 0 0-.5.707v14.522c0 .318.22.6.5.707a9.735 9.735 0 0 0 3.25.555 9.707 9.707 0 0 0 5.25-1.533v-1.37a.75.75 0 0 0-.56-.723c-1.428-.344-2.285-.945-2.285-1.717s.857-1.373 2.285-1.717a.75.75 0 0 0 .56-.723v-1.37c0-.629-.444-1.21-1.141-1.423-1.02-.3-1.859-.933-1.859-1.828s.839-1.528 1.859-1.828c.697-.213 1.141-.794 1.141-1.423v-1.37A9.707 9.707 0 0 0 18 3Z" />
                    </svg>
                    Dashboard
                </a>
                <a href="/dashboard/stats"
                    class="flex items-center gap-3 px-4 py-2 text-slate-600 font-semibold rounded-lg hover:bg-purple-50 hover:text-purple-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path fill-rule="evenodd"
                            d="M2.25 13.5a8.25 8.25 0 0 1 8.25-8.25.75.75 0 0 1 .75.75v6.75H18a.75.75 0 0 1 .75.75 8.25 8.25 0 0 1-16.5 0Z"
                            clip-rule="evenodd" />
                        <path fill-rule="evenodd"
                            d="M12.75 3a.75.75 0 0 1 .75-.75 8.25 8.25 0 0 1 8.25 8.25.75.75 0 0 1-.75.75h-7.5a.75.75 0 0 1-.75-.75V3Z"
                            clip-rule="evenodd" />
                    </svg>
                    Stats
                </a>
                <a href="/dashboard/tracker"
                    class="flex items-center gap-3 px-4 py-2 text-slate-600 font-semibold rounded-lg hover:bg-purple-50 hover:text-purple-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path
                            d="m11.08 4.135.418-.21a.75.75 0 0 1 .864 1.22l-1.01 1.01a.75.75 0 0 1-1.06 0l-2.12-2.122a.75.75 0 0 1 1.06-1.06l1.85 1.85ZM12 5.25a.75.75 0 0 1 .75.75v.008l.008.008a.75.75 0 0 1 0 1.052l-.008.008a.75.75 0 0 1-1.052 0l-.008-.008a.75.75 0 0 1 .3-1.06Zm-2.71 4.46a.75.75 0 0 1 0 1.06l-1.01 1.01a.75.75 0 0 1-1.22-.864l.21-.418 1.85-1.85a.75.75 0 0 1 1.06 0Zm10.53-2.181a.75.75 0 0 0-1.06-1.06l-1.85 1.85-.21.418a.75.75 0 0 0 .865 1.22l1.01-1.01a.75.75 0 0 0 0-1.06ZM12 15.75a.75.75 0 0 1 .75.75v.008l.008.008a.75.75 0 0 1 0 1.052l-.008.008a.75.75 0 0 1-1.052 0l-.008-.008a.75.75 0 0 1 .3-1.06ZM9.29 16.03a.75.75 0 0 0 0 1.06l-1.01 1.01a.75.75 0 1 0 1.22.865l.418-.21 1.85-1.85a.75.75 0 0 0-1.06-1.06l-1.42 1.42Zm3.78-2.81a.75.75 0 0 1 1.06 0l2.12 2.121a.75.75 0 0 1-1.06 1.06l-1.85-1.85.418-.21a.75.75 0 0 1 .865 1.22l-1.01 1.01a.75.75 0 0 1-1.06 0l-2.12-2.122a.75.75 0 0 1 1.06-1.06Zm-3.78 2.81a.75.75 0 0 1 1.06 0l1.42-1.42 1.85 1.85.21.418a.75.75 0 0 1-.865 1.22l-1.01-1.01a.75.75 0 0 1 0-1.06ZM12 2.25a9.75 9.75 0 1 0 0 19.5 9.75 9.75 0 0 0 0-19.5Z" />
                    </svg>
                    Tracker
                </a>
            </nav>
            <a href="/logout"
                class="mt-auto flex items-center gap-3 px-4 py-2 text-slate-600 font-semibold rounded-lg hover:bg-red-50 hover:text-red-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path fill-rule="evenodd"
                        d="M7.5 3.75A1.5 1.5 0 0 0 6 5.25v13.5a1.5 1.5 0 0 0 1.5 1.5h6a1.5 1.5 0 0 0 1.5-1.5V15a.75.75 0 0 1 1.5 0v3.75a3 3 0 0 1-3 3h-6a3 3 0 0 1-3-3V5.25a3 3 0 0 1 3-3h6a3 3 0 0 1 3 3V9A.75.75 0 0 1 15 9V5.25a1.5 1.5 0 0 0-1.5-1.5h-6Zm10.72 4.72a.75.75 0 0 1 1.06 0l3 3a.75.75 0 0 1 0 1.06l-3 3a.75.75 0 1 1-1.06-1.06l1.72-1.72H9a.75.75 0 0 1 0-1.5h10.94l-1.72-1.72a.75.75 0 0 1 0-1.06Z"
                        clip-rule="evenodd" />
                </svg>
                Logout
            </a>
        </aside>

        <div id="main-scroll-panel" class="flex-1 flex flex-col h-screen overflow-y-auto">
            <header class="sticky top-0 bg-[#F8F7FF]/60 backdrop-blur-xl z-10 border-b border-white/20">
                <div class="flex justify-between items-center px-6 py-4">
                    <h1 class="text-xl font-bold text-slate-900">College Planning Path</h1>
                </div>
            </header>

            <main class="flex-1 p-6">
                <div class="grid grid-cols-1 xl:grid-cols-5 gap-6 h-full">

                    <div class="xl:col-span-2 bg-white/60 backdrop-blur-xl border border-white/20 rounded-2xl shadow-lg shadow-indigo-100/30 p-6 flex flex-col h-[85vh]"
                        data-aos="fade-right">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-slate-900 font-lalezar">AI Assistant</h2>
                            <button id="reset-chat-btn" title="Reset Chat History"
                                class="flex items-center gap-2 text-sm text-slate-500 font-semibold hover:text-red-600 transition-colors py-1 px-3 rounded-lg hover:bg-red-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-red-500">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                    class="w-5 h-5">
                                    <path fill-rule="evenodd"
                                        d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-1.157.06-2.185.44-3.094 1.1a.75.75 0 0 0 .537 1.344C4.1 6.1 4.9 5.75 6 5.75v9.5c-1.1 0-1.9.35-2.557.89a.75.75 0 0 0 .537 1.344c.91-.66 1.936-1.034 3.094-1.1v.443A2.75 2.75 0 0 0 8.75 19h2.5A2.75 2.75 0 0 0 14 16.25v-12.5A2.75 2.75 0 0 0 11.25 1h-2.5ZM7.5 3.75a1.25 1.25 0 0 1 1.25-1.25h2.5a1.25 1.25 0 0 1 1.25 1.25v12.5a1.25 1.25 0 0 1-1.25-1.25h-2.5a1.25 1.25 0 0 1-1.25-1.25v-12.5Z"
                                        clip-rule="evenodd" />
                                </svg>
                                Reset Chat
                            </button>
                        </div>
                        <div id="chat-history" class="flex-grow overflow-y-auto space-y-4 pr-2 -mr-2"></div>
                        <div class="mt-4 flex items-center gap-2 pt-4 border-t border-slate-200/80">
                            <input type="text" id="userInput" placeholder="Ask a question..."
                                class="w-full bg-white/50 border border-slate-300/70 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition disabled:bg-slate-100"
                                disabled>
                            <button id="send-btn"
                                class="bg-indigo-600 text-white p-2.5 rounded-lg hover:bg-indigo-700 font-semibold transition disabled:bg-slate-400 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2"
                                disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                                    class="w-5 h-5">
                                    <path
                                        d="M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="xl:col-span-3 bg-white/60 backdrop-blur-xl border border-white/20 rounded-2xl shadow-lg shadow-indigo-100/30 p-6 relative flex flex-col overflow-hidden"
                        data-aos="fade-left" data-aos-delay="100">
                        <h1 class="text-3xl font-bold font-lalezar text-indigo-700 mb-1">Your Personalized Path</h1>
                        <p class="text-slate-600 mb-6">Complete each task to move to the next step. Click a node for
                            details.</p>

                        <div class="relative flex-grow mb-4 min-h-0 overflow-clip">
                            <svg id="path-svg" class="absolute top-0 left-0 w-full h-full z-0">
                                <path id="connector-path" d="" stroke="#C7D2FE" stroke-width="3" fill="none"
                                    stroke-dasharray="2 8" stroke-linecap="round" />
                            </svg>
                            <div id="path-nodes-container" class="space-y-10 relative z-10 p-4"></div>
                        </div>

                        <div class="mt-auto pt-6 border-t border-slate-200/80 flex justify-end">
                            <a href="{{ url_for('college_path_builder') }}"
                                class="bg-indigo-600 text-white px-5 py-2.5 rounded-lg hover:bg-indigo-700 font-semibold transition shadow-md hover:shadow-lg transform hover:-translate-y-0.5 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2">
                                Edit Path Info
                            </a>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="taskModal"
        class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4"
        aria-labelledby="modal-title-task" role="dialog" aria-modal="true">
        <div id="modal-panel"
            class="bg-white/60 backdrop-blur-xl border border-white/20 w-full max-w-lg rounded-2xl shadow-2xl p-6 md:p-8"
            data-aos="zoom-in" data-aos-duration="400">
            <div class="flex justify-between items-start">
                <h3 id="modalTitle" class="text-2xl font-bold font-lalezar text-indigo-700 mb-4">Task Details</h3>
                <button onclick="closeTaskModal()"
                    class="text-slate-400 hover:text-slate-600 transition-colors rounded-full p-1 -mt-2 -mr-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500">
                    <span class="sr-only">Close</span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd"
                            d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z"
                            clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <p id="modalDescription" class="text-slate-700 mb-6"></p>
            <div id="modal-actions" class="flex justify-end gap-3"></div>
        </div>
    </div>

    <div id="statEntryModal"
        class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4"
        aria-labelledby="modal-title-stat" role="dialog" aria-modal="true">
        <div id="stat-modal-panel"
            class="bg-white/60 backdrop-blur-xl border border-white/20 w-full max-w-lg rounded-2xl shadow-2xl p-6 md:p-8"
            data-aos="zoom-in" data-aos-duration="400">
            <div class="flex justify-between items-start">
                <h3 id="statModalTitle" class="text-2xl font-bold font-lalezar text-indigo-700 mb-2">Update Your
                    Progress</h3>
                <button onclick="closeStatModal()"
                    class="text-slate-400 hover:text-slate-600 transition-colors rounded-full p-1 -mt-2 -mr-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500">
                    <span class="sr-only">Close</span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd"
                            d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z"
                            clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <p class="text-slate-600 mb-6">Great job on this milestone! Please enter your progress.</p>
            <div class="space-y-4">
                <div>
                    <label id="statModalLabel" for="statValue"
                        class="block text-sm font-semibold text-slate-700 mb-1">New Value</label>
                    <input type="number" id="statValue" name="statValue"
                        class="w-full bg-white/50 border border-slate-300/70 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
                        placeholder="Enter value...">
                    <input type="hidden" id="statNameToUpdate">
                </div>
                <div id="stat-modal-actions" class="flex justify-end gap-3 pt-2">
                    <button onclick="closeStatModal()"
                        class="text-slate-600 font-semibold px-4 py-2 rounded-lg hover:bg-slate-100 transition">Cancel</button>
                    <button onclick="handleSaveStat()"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition">Save
                        Progress</button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/prompt.js') }}"></script>
    <script src="{{ url_for('static', filename='js/alert.js') }}"></script>
    <script>
        let currentTasks = [];
        let currentTaskId = null;
        let conversationHistory = [];
        const chatCategory = 'College Planning'; // Define category for this page

        // Function to load chat history from the server
        async function loadChatHistory() {
            try {
                const response = await fetch(`/api/chat_history?category=${chatCategory}`);
                if (response.ok) {
                    const history = await response.json();
                    if (history && history.length > 0) {
                        conversationHistory = history;
                        const chatHistoryDiv = document.getElementById('chat-history');
                        chatHistoryDiv.innerHTML = '';
                        conversationHistory.forEach(msg => appendChatMessage(msg.content, msg.role));
                        document.getElementById('userInput').disabled = false;
                        document.getElementById('send-btn').disabled = false;
                    } else {
                        startInitialChat();
                    }
                } else {
                    startInitialChat();
                }
            } catch (error) {
                console.error("Could not load chat history:", error);
                startInitialChat();
            }
        }

        // Function to trigger the initial greeting from the bot
        function startInitialChat() {
            conversationHistory.push({ role: 'user', content: 'INITIAL_MESSAGE' });
            handleUserChat();
        }

        async function fetchPath(isRegeneration = false) {
            const nodesContainer = document.getElementById('path-nodes-container');
            nodesContainer.innerHTML = `<div class="text-center text-slate-500 p-8">${isRegeneration ? 'Generating new path...' : 'Loading your path...'}</div>`;
            try {
                const response = await fetch(`/api/tasks?category=${chatCategory}`, { method: isRegeneration ? 'POST' : 'GET' });
                if (!response.ok) throw new Error('Network response was not ok');
                const tasks = await response.json();
                if (Array.isArray(tasks) && tasks.length > 0) {
                    currentTasks = tasks.map((task, index) => ({ ...task, client_id: index + 1, status: task.is_completed ? 'complete' : 'pending' }));
                    renderPathAndConnectors(currentTasks, true); // Animate on fetch
                } else { window.location.href = "{{ url_for('college_path_builder') }}"; }
            } catch (error) {
                console.error('Error fetching path:', error);
                nodesContainer.innerHTML = `<div class="text-center p-8"><p class="text-red-500 mb-4">Could not load path.</p><button onclick="fetchPath(true)" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Try Again</button></div>`;
            }
        }

        async function renderPathAndConnectors(tasks, withAnimation = false) {
            const nodesContainer = document.getElementById('path-nodes-container');
            const svgContainer = document.getElementById('path-svg');
            nodesContainer.innerHTML = '';
            svgContainer.innerHTML = ''; // Clear old connectors

            const firstPendingIndex = tasks.findIndex(t => t.status === 'pending');

            // Create all node elements first
            tasks.forEach((task, index) => {
                const isCompleted = task.status === 'complete';
                const isUnlocked = index === firstPendingIndex;
                const isLocked = index > firstPendingIndex && firstPendingIndex !== -1;

                const alignmentWrapper = document.createElement('div');
                alignmentWrapper.className = 'flex';
                const positions = ['justify-start', 'justify-center', 'justify-end'];
                alignmentWrapper.classList.add(...positions[index % 3].split(' '));

                const taskButton = document.createElement('button');
                taskButton.id = `task-node-${task.client_id}`;
                taskButton.className = 'task-node w-28 h-28 rounded-full flex items-center justify-center font-bold text-4xl text-white transition-all duration-300 transform hover:scale-110 focus:outline-none focus-visible:ring-4 focus-visible:ring-offset-2 focus-visible:ring-indigo-400';
                taskButton.onclick = () => openTaskModal(task);
                taskButton.disabled = isLocked;

                if (isCompleted) {
                    taskButton.classList.add('bg-emerald-500', 'shadow-lg');
                    taskButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10"><path fill-rule="evenodd" d="M19.916 4.626a.75.75 0 0 1 .208 1.04l-9 13.5a.75.75 0 0 1-1.154.114l-6-6a.75.75 0 0 1 1.06-1.06l5.353 5.353 8.493-12.74a.75.75 0 0 1 1.04-.207Z" clip-rule="evenodd" /></svg>`;
                } else if (isUnlocked) {
                    taskButton.classList.add('bg-indigo-500', 'shadow-lg', 'shadow-indigo-400/50');
                    taskButton.textContent = task.client_id;
                } else {
                    taskButton.classList.add('bg-slate-300', 'cursor-not-allowed');
                    taskButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10 text-slate-500"><path fill-rule="evenodd" d="M12 1.5a5.25 5.25 0 0 0-5.25 5.25v3a3 3 0 0 0-3 3v6.75a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3v-6.75a3 3 0 0 0-3-3v-3c0-2.9-2.35-5.25-5.25-5.25Zm3.75 8.25v-3a3.75 3.75 0 1 0-7.5 0v3h7.5Z" clip-rule="evenodd" /></svg>`;
                }

                if (!withAnimation) {
                    taskButton.classList.add('visible');
                    if (isUnlocked) taskButton.classList.add('animate-pulse');
                }

                alignmentWrapper.appendChild(taskButton);
                nodesContainer.appendChild(alignmentWrapper);
            });

            if (withAnimation) {
                const nodeElements = Array.from(nodesContainer.querySelectorAll('.task-node'));
                for (let i = 0; i < nodeElements.length; i++) {
                    const node = nodeElements[i];
                    await new Promise(resolve => setTimeout(resolve, 100));
                    node.classList.add('visible');
                    if (node.classList.contains('bg-indigo-500')) {
                        node.classList.add('animate-pulse');
                    }
                    await new Promise(resolve => setTimeout(resolve, 200));
                    if (i < nodeElements.length - 1) {
                        await drawAndAnimateConnector(nodeElements[i], nodeElements[i + 1]);
                    }
                }
            } else {
                redrawAllConnectors();
            }
        }

        async function drawAndAnimateConnector(startNode, endNode) {
            const svg = document.getElementById('path-svg');
            if (!svg || !startNode || !endNode) return;

            const containerRect = svg.getBoundingClientRect();
            const startRect = startNode.getBoundingClientRect();
            const endRect = endNode.getBoundingClientRect();

            const startX = startRect.left + startRect.width / 2 - containerRect.left;
            const startY = startRect.top + startRect.height / 2 - containerRect.top;
            const endX = endRect.left + endRect.width / 2 - containerRect.left;
            const endY = endRect.top + endRect.height / 2 - containerRect.top;

            const controlX1 = startX + (endX - startX) * 0.2;
            const controlY1 = startY + (endY - startY) * 0.8;
            const controlX2 = startX + (endX - startX) * 0.8;
            const controlY2 = startY + (endY - startY) * 0.2;

            const pathData = `M ${startX} ${startY} C ${controlX1} ${controlY1}, ${controlX2} ${controlY2}, ${endX} ${endY}`;

            // Create a temporary, invisible path to measure
            const tempPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            tempPath.setAttribute('d', pathData);
            const totalLength = tempPath.getTotalLength();

            const dashLength = 8;
            const gapLength = 6;
            const patternLength = dashLength + gapLength;
            const dashSegments = [];

            // Create individual line segments for each dash
            for (let currentLength = 0; currentLength < totalLength; currentLength += patternLength) {
                const start = tempPath.getPointAtLength(currentLength);
                const end = tempPath.getPointAtLength(Math.min(currentLength + dashLength, totalLength));

                const segment = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                segment.setAttribute('x1', start.x);
                segment.setAttribute('y1', start.y);
                segment.setAttribute('x2', end.x);
                segment.setAttribute('y2', end.y);
                segment.setAttribute('stroke', '#C7D2FE');
                segment.setAttribute('stroke-width', '3');
                segment.setAttribute('stroke-linecap', 'round');
                segment.classList.add('dash-segment');
                segment.style.transformOrigin = `${(start.x + end.x) / 2}px ${(start.y + end.y) / 2}px`;

                svg.appendChild(segment);
                dashSegments.push(segment);
            }

            // Animate them in one by one
            const delayBetweenDashes = 20; // ms
            for (let i = 0; i < dashSegments.length; i++) {
                const segment = dashSegments[i];
                segment.style.animationDelay = `${i * delayBetweenDashes}ms`;
                segment.classList.add('animate-in');
            }
            const totalAnimationTime = dashSegments.length * delayBetweenDashes + 200;
            await new Promise(resolve => setTimeout(resolve, totalAnimationTime));
        }

        function redrawAllConnectors() {
            const svg = document.getElementById('path-svg');
            const nodes = Array.from(document.querySelectorAll('.task-node.visible'));
            if (!svg || nodes.length < 2) return;

            svg.innerHTML = '';
            const containerRect = svg.getBoundingClientRect();

            for (let i = 0; i < nodes.length - 1; i++) {
                const startNode = nodes[i];
                const endNode = nodes[i + 1];
                if (!startNode || !endNode) continue;

                const startRect = startNode.getBoundingClientRect();
                const endRect = endNode.getBoundingClientRect();

                const startX = startRect.left + startRect.width / 2 - containerRect.left;
                const startY = startRect.top + startRect.height / 2 - containerRect.top;
                const endX = endRect.left + endRect.width / 2 - containerRect.left;
                const endY = endRect.top + endRect.height / 2 - containerRect.top;

                const controlX1 = startX + (endX - startX) * 0.2;
                const controlY1 = startY + (endY - startY) * 0.8;
                const controlX2 = startX + (endX - startX) * 0.8;
                const controlY2 = startY + (endY - startY) * 0.2;

                const pathData = `M ${startX} ${startY} C ${controlX1} ${controlY1}, ${controlX2} ${controlY2}, ${endX} ${endY}`;

                // Create a temporary, invisible path to measure
                const tempPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                tempPath.setAttribute('d', pathData);
                const totalLength = tempPath.getTotalLength();

                const dashLength = 8;
                const gapLength = 6;
                const patternLength = dashLength + gapLength;

                // Create individual line segments for each dash
                for (let currentLength = 0; currentLength < totalLength; currentLength += patternLength) {
                    const start = tempPath.getPointAtLength(currentLength);
                    const end = tempPath.getPointAtLength(Math.min(currentLength + dashLength, totalLength));

                    const segment = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    segment.setAttribute('x1', start.x);
                    segment.setAttribute('y1', start.y);
                    segment.setAttribute('x2', end.x);
                    segment.setAttribute('y2', end.y);
                    segment.setAttribute('stroke', '#C7D2FE');
                    segment.setAttribute('stroke-width', '3');
                    segment.setAttribute('stroke-linecap', 'round');
                    svg.appendChild(segment);
                }
            }
        }

        function openTaskModal(task) {
            currentTaskId = task.id;
            const modal = document.getElementById('taskModal');
            document.getElementById('modalTitle').textContent = `Step ${task.client_id}: Your Task`;
            document.getElementById('modalDescription').textContent = task.description;
            document.getElementById('modal-actions').innerHTML = `
                <button onclick="handleImStuck()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition">I'm Stuck</button>
                <button onclick="handleTaskAction('complete')" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg transition">Mark as Complete</button>`;
            modal.classList.remove('hidden');
        }

        function closeTaskModal() { document.getElementById('taskModal').classList.add('hidden'); }
        function closeStatModal() { document.getElementById('statEntryModal').classList.add('hidden'); }

        async function handleImStuck() {
            const task = currentTasks.find(t => t.id === currentTaskId);
            if (!task) return;
            closeTaskModal();
            const reason = await prompt(`You're working on the task:\n"${task.description}"`, '', 'What part is giving you trouble?');
            if (reason && reason.trim() !== "") {
                const chatInput = document.getElementById('userInput');
                chatInput.value = `I'm having trouble with the task: "${task.description}". Specifically, my problem is: ${reason}`;
                handleUserChat();
                chatInput.focus();
            }
        }

        async function handleTaskAction(status) {
            const task = currentTasks.find(t => t.id === currentTaskId);
            if (!task) return;
            closeTaskModal();
            try {
                const response = await fetch('/api/update_task_status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ taskId: task.id, status: status })
                });
                if (!response.ok) throw new Error('Could not update task status');
                const result = await response.json();
                if (status === 'complete') {
                    const taskIndex = currentTasks.findIndex(t => t.id === currentTaskId);
                    if (taskIndex !== -1) currentTasks[taskIndex].status = 'complete';
                    renderPathAndConnectors(currentTasks, false); // No animation on complete
                    if (task.type === 'milestone' && task.stat_to_update) {
                        setTimeout(() => openStatModal(task), 500);
                    } else { await checkPathCompletion(); }
                }
            } catch (error) {
                console.error("Error updating task status:", error);
                alert("Could not update task. Please try again.");
            }
        }

        async function checkPathCompletion() {
            const allComplete = currentTasks.every(t => t.status === 'complete');
            if (allComplete && currentTasks.length > 0) {
                setTimeout(async () => {
                    alert("Great job! Generating your next set of challenges.");
                    await fetchPath(true);
                }, 500);
            }
        }

        function openStatModal(task) {
            const statName = task.stat_to_update;
            const modal = document.getElementById('statEntryModal');
            const modalTitle = document.getElementById('statModalTitle');
            const modalLabel = document.getElementById('statModalLabel');
            const statValueInput = document.getElementById('statValue');
            const statNameToUpdate = document.getElementById('statNameToUpdate');

            const statDetails = {
                "gpa": { name: "New GPA", placeholder: "Enter new GPA (e.g., 3.85)", min: 0, max: 5 },
                "colleges_researched": { name: "Number of Colleges Researched", placeholder: "Enter a number", min: 0 },
                "essay_progress": { name: "Essay Progress", placeholder: "1=Draft, 2=Final", min: 1, max: 2 },
                "applications_submitted": { name: "Applications Submitted", placeholder: "Enter a number", min: 0 }
            };

            const details = statDetails[statName] || { name: "Update Progress", placeholder: "Enter value" };

            modalTitle.textContent = `Update: ${details.name}`;
            modalLabel.textContent = details.name;
            statValueInput.placeholder = details.placeholder;
            statValueInput.min = details.min || "";
            statValueInput.max = details.max || "";
            statNameToUpdate.value = statName;

            statValueInput.value = ""; // Clear previous input

            // Update the descriptive paragraph for clarity
            const p = modal.querySelector('p');
            p.innerHTML = `Great job on this milestone! The information you enter will be saved to your <a href="/dashboard/stats" class="text-indigo-600 hover:underline font-semibold">Stats</a> page and will help tailor your future college planning paths.`;

            modal.classList.remove('hidden');
        }

        async function handleSaveStat() {
            const statValueInput = document.getElementById('statValue');
            const stat_name = document.getElementById('statNameToUpdate').value;
            const stat_value = statValueInput.value;

            // --- START: VALIDATION LOGIC ---
            if (!stat_value) {
                alert("Please enter a value.");
                return;
            }

            const valueNum = parseFloat(stat_value);
            const min = parseFloat(statValueInput.min);
            const max = parseFloat(statValueInput.max);

            if (!isNaN(min) && valueNum < min) {
                alert(`The score cannot be less than ${min}. Please enter a valid score.`);
                return;
            }
            if (!isNaN(max) && valueNum > max) {
                alert(`The score cannot be greater than ${max}. Please enter a valid score.`);
                return;
            }
            // --- END: VALIDATION LOGIC ---

            try {
                const response = await fetch('/api/update_stats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stat_name, stat_value })
                });
                if (!response.ok) throw new Error('Failed to save stats.');
                const result = await response.json();
                if (result.success) {
                    alert("Your stats have been updated!");
                    closeStatModal();
                    await checkPathCompletion();
                } else { throw new Error(result.error || 'An unknown error occurred.'); }
            } catch (error) {
                console.error("Error saving stat:", error);
                alert("Could not save your stats. Please try again.");
            }
        }

        async function handleUserChat() {
            const chatInput = document.getElementById('userInput');
            const sendButton = document.getElementById('send-btn');
            let message = chatInput.value.trim();
            const isInitialMessage = conversationHistory.length > 0 && conversationHistory[conversationHistory.length - 1].content === 'INITIAL_MESSAGE';

            if (isInitialMessage) {
                chatInput.value = "";
            } else if (message === "") {
                return;
            }

            if (!isInitialMessage) {
                appendChatMessage(message, 'user');
                conversationHistory.push({ role: 'user', content: message });
            }

            chatInput.value = "";
            chatInput.disabled = true;
            sendButton.disabled = true;
            const typingIndicator = appendChatMessage('...', 'bot', true);

            try {
                const response = await fetch(`/api/chat?category=${chatCategory}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ history: conversationHistory })
                });
                if (!response.ok) throw new Error('AI response error.');

                const data = await response.json();
                typingIndicator.remove();

                if (isInitialMessage) {
                    conversationHistory = [];
                }

                if (data.new_path) {
                    appendChatMessage("I've generated a new college planning path for you based on our conversation.", 'bot');
                    conversationHistory.push({ role: 'assistant', content: "I've generated a new college planning path for you based on our conversation." });
                    currentTasks = data.new_path.map((task, index) => ({ ...task, client_id: index + 1, status: task.is_completed ? 'complete' : 'pending' }));
                    renderPathAndConnectors(currentTasks, true);
                } else {
                    const aiReply = data.reply;
                    appendChatMessage(aiReply, 'bot');
                    conversationHistory.push({ role: 'assistant', content: aiReply });
                }

            } catch (error) {
                typingIndicator.querySelector('p').textContent = "Sorry, I'm having trouble connecting.";
                console.error("Chat error:", error);
            } finally {
                chatInput.disabled = false;
                sendButton.disabled = false;
                chatInput.focus();
            }
        }

        // NEW: Function to handle chat reset
        async function handleResetChat() {
            if (confirm("Are you sure you want to reset your chat history? This cannot be undone.")) {
                try {
                    const response = await fetch('/api/reset_chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ category: chatCategory })
                    });
                    if (!response.ok) throw new Error('Failed to reset chat.');

                    document.getElementById('chat-history').innerHTML = '';
                    conversationHistory = [];
                    startInitialChat(); // Get a fresh greeting from the bot
                } catch (error) {
                    console.error("Error resetting chat:", error);
                    alert("Could not reset chat history. Please try again.");
                }
            }
        }

        function appendChatMessage(text, role, isTyping = false) {
            const chatHistory = document.getElementById('chat-history');
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'flex ' + (role === 'user' ? 'justify-end' : 'justify-start');
            const messageDiv = document.createElement('div');
            let cssClass = 'p-3 rounded-xl max-w-xs text-sm';
            if (role === 'user') { cssClass += ' bg-indigo-600 text-white'; }
            else {
                cssClass += ' bg-white/80 text-slate-700';
                if (isTyping) cssClass += ' animate-pulse';
            }
            messageDiv.className = cssClass;
            // A simple markdown-to-HTML conversion
            let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            messageDiv.innerHTML = `<p>${formattedText}</p>`;
            messageWrapper.appendChild(messageDiv);
            chatHistory.appendChild(messageWrapper);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return messageWrapper;
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchPath();
            loadChatHistory();
            document.getElementById('main-scroll-panel').addEventListener('scroll', redrawAllConnectors);
        });
        window.addEventListener('resize', () => redrawAllConnectors());
        document.getElementById('send-btn').addEventListener('click', handleUserChat);
        document.getElementById('userInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleUserChat(); });
        document.getElementById('reset-chat-btn').addEventListener('click', handleResetChat);
    </script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>AOS.init({ once: true, duration: 800 });</script>
</body>

</html>