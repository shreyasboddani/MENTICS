<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker â€“ Mentics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Lalezar&display=swap"
        rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
</head>

<body class="bg-slate-50 font-sans text-slate-800 antialiased">

    <div class="background-shapes">
        <div class="shape-1"></div>
        <div class="shape-2"></div>
    </div>

    <header class="top-nav">
        <div class="flex justify-between items-center">
            <a href="/" class="text-3xl font-bold text-purple-600 tracking-tight font-lalezar">MENTICS</a>
            <nav class="flex items-center space-x-2">
                <a href="/dashboard" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                    </svg>
                    <span>Dashboard</span>
                </a>
                <a href="/dashboard/stats" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" />
                        <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" />
                    </svg>
                    <span>Stats</span>
                </a>
                <a href="/dashboard/tracker" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V4a1 1 0 011-1zm10 8a1 1 0 011-1h3a1 1 0 011 1v4a1 1 0 01-1 1h-3a1 1 0 01-1-1v-4zm-7 1a1 1 0 011-1h2a1 1 0 011 1v3a1 1 0 01-1 1H8a1 1 0 01-1-1v-3z"
                            clip-rule="evenodd" />
                    </svg>
                    <span>Tracker</span>
                </a>
                <a href="/leaderboard" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                            clip-rule="evenodd" />
                    </svg>
                    <span>Leaderboard</span>
                </a>
                <a href="/forum" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.293 2.293a1 1 0 011.414 0L10 11.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" />
                    </svg>
                    <span>Forum</span>
                </a>
                <a href="/account" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                            clip-rule="evenodd" />
                    </svg>
                    <span>Account</span>
                </a>
            </nav>
            <a href="/logout" class="nav-item !text-red-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z"
                        clip-rule="evenodd" />
                </svg>
                <span>Logout</span>
            </a>
        </div>
    </header>

    <main class="p-6 lg:p-8">
        <div data-aos="fade-in" class="mb-8">
            <h1 class="text-4xl md:text-5xl font-bold font-lalezar text-slate-800">Progress Tracker</h1>
            <p class="text-lg text-slate-600">Visualize your growth and review your history.</p>
        </div>

        <div class="space-y-8">
            <section data-aos="fade-up">
                <h2 class="text-2xl font-bold font-lalezar text-purple-700 mb-4">Test Score Tracker</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-800">SAT Score Progression</h3>
                            <select id="sat-subject-selector"
                                class="text-sm bg-white/50 border border-slate-300/70 rounded-lg p-1 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition">
                                <option value="total">Total</option>
                                <option value="sat_math">Math</option>
                                <option value="sat_ebrw">EBRW</option>
                            </select>
                        </div>
                        <div class="h-64"><canvas id="satChart"></canvas></div>
                    </div>
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-800">ACT Score Progression</h3>
                            <select id="act-subject-selector"
                                class="text-sm bg-white/50 border border-slate-300/70 rounded-lg p-1 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                                <option value="composite">Composite</option>
                                <option value="act_math">Math</option>
                                <option value="act_reading">Reading</option>
                                <option value="act_science">Science</option>
                            </select>
                        </div>
                        <div class="h-64"><canvas id="actChart"></canvas></div>
                    </div>
                </div>
            </section>

            <section data-aos="fade-up" data-aos-delay="100">
                <h2 class="text-2xl font-bold font-lalezar text-indigo-700 mb-4">College Planning Progress</h2>
                <div class="card p-6">
                    <h3 class="font-bold text-slate-800 mb-4">Application Progress Tracker</h3>
                    <div class="h-64"><canvas id="collegeChart"></canvas></div>
                </div>
            </section>

            <section data-aos="fade-up" data-aos-delay="200">
                <h2 class="text-2xl font-bold font-lalezar text-slate-700 mb-4">Path History</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card p-6">
                        <h3 class="font-semibold text-slate-800 mb-2">Test Prep Paths</h3>
                        <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
                            {% for date, tasks in test_prep_generations.items() %}
                            <div class="p-4 bg-purple-50/50 rounded-lg">
                                <p class="text-sm font-semibold text-purple-800">Generated: {{ date | format_date }}
                                </p>
                                <ul class="mt-2 text-sm space-y-1">
                                    {% for task in tasks %}
                                    <li
                                        class="flex items-center gap-2 {% if not task['is_completed'] %}text-slate-500{% endif %}">
                                        {% if task['is_completed'] %}
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                            class="w-5 h-5 text-emerald-500 flex-shrink-0">
                                            <path fill-rule="evenodd"
                                                d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z"
                                                clip-rule="evenodd" />
                                        </svg>
                                        {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                            class="w-5 h-5 text-slate-400 flex-shrink-0">
                                            <path fill-rule="evenodd"
                                                d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16ZM8.28 7.22a.75.75 0 0 0-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 1 0 1.06 1.06L10 11.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L11.06 10l1.72-1.72a.75.75 0 0 0-1.06-1.06L10 8.94 8.28 7.22Z"
                                                clip-rule="evenodd" />
                                        </svg>
                                        {% endif %}
                                        <span>{{ task['description'] }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% else %}
                            <p class="text-slate-500 text-center py-8">No Test Prep history found.</p>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="font-semibold text-slate-800 mb-2">College Planning Paths</h3>
                        <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
                            {% for date, tasks in college_planning_generations.items() %}
                            <div class="p-4 bg-indigo-50/50 rounded-lg">
                                <p class="text-sm font-semibold text-indigo-800">Generated: {{ date | format_date }}
                                </p>
                                <ul class="mt-2 text-sm space-y-1">
                                    {% for task in tasks %}
                                    <li
                                        class="flex items-center gap-2 {% if not task['is_completed'] %}text-slate-500{% endif %}">
                                        {% if task['is_completed'] %}
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                            class="w-5 h-5 text-emerald-500 flex-shrink-0">
                                            <path fill-rule="evenodd"
                                                d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z"
                                                clip-rule="evenodd" />
                                        </svg>
                                        {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                            class="w-5 h-5 text-slate-400 flex-shrink-0">
                                            <path fill-rule="evenodd"
                                                d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16ZM8.28 7.22a.75.75 0 0 0-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 1 0 1.06 1.06L10 11.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L11.06 10l1.72-1.72a.75.75 0 0 0-1.06-1.06L10 8.94 8.28 7.22Z"
                                                clip-rule="evenodd" />
                                        </svg>
                                        {% endif %}
                                        <span>{{ task['description'] }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% else %}
                            <p class="text-slate-500 text-center py-8">No College Planning history found.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const statHistory = {{ stat_history| tojson
            }};
            // Get the user's local timezone
            const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

        let satChartInstance;
        let actChartInstance;
        let collegeChartInstance;

        function renderSatChart(subject = 'total') {
            const ctx = document.getElementById('satChart').getContext('2d');
            let labels = [];
            let data = [];
            let label = 'SAT Total Score';
            let yAxisMin = 400;
            let yAxisMax = 1600;

            const historyData = statHistory[subject === 'total' ? 'sat_total' : subject] || [];

            historyData.forEach(item => {
                // Use the user's timezone for consistent date formatting
                const date = new Date(item.date + 'T00:00:00'); // Assume date is YYYY-MM-DD from server
                labels.push(date.toLocaleDateString(undefined, { timeZone: userTimezone, month: 'short', day: 'numeric' }));
                data.push(item.value);
            });

            if (subject !== 'total') {
                yAxisMin = 200;
                yAxisMax = 800;
                label = subject === 'sat_math' ? 'SAT Math Score' : 'SAT EBRW Score';
            }

            if (satChartInstance) satChartInstance.destroy();

            satChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: 'rgba(167, 139, 250, 0.6)',
                        borderColor: 'rgba(167, 139, 250, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { min: yAxisMin, max: yAxisMax, grid: { color: '#e2e8f0' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function renderActChart(subject = 'composite') {
            const ctx = document.getElementById('actChart').getContext('2d');
            let labels = [];
            let data = [];
            let label;

            const dataKey = subject === 'composite' ? 'act_composite' : subject;
            const historyData = statHistory[dataKey] || [];

            if (subject === 'composite') {
                label = 'ACT Composite Score';
            } else {
                const subjectName = subject.split('_')[1];
                label = `ACT ${subjectName.charAt(0).toUpperCase() + subjectName.slice(1)} Score`;
            }

            historyData.forEach(item => {
                // Use the user's timezone
                const date = new Date(item.date + 'T00:00:00'); // Assume date is YYYY-MM-DD from server
                labels.push(date.toLocaleDateString(undefined, { timeZone: userTimezone, month: 'short', day: 'numeric' }));
                data.push(item.value);
            });

            if (actChartInstance) actChartInstance.destroy();

            actChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: 'rgba(99, 102, 241, 0.6)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { min: 0, max: 36, grid: { color: '#e2e8f0' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function renderCollegeChart() {
            const ctx = document.getElementById('collegeChart').getContext('2d');
            const collegesResearched = statHistory.colleges_researched || [];
            const appsSubmitted = statHistory.applications_submitted || [];
            const essayProgress = statHistory.essay_progress || [];

            const latestResearched = collegesResearched.length > 0 ? collegesResearched[collegesResearched.length - 1].value : 0;
            const latestSubmitted = appsSubmitted.length > 0 ? appsSubmitted[appsSubmitted.length - 1].value : 0;
            const latestEssay = essayProgress.length > 0 ? essayProgress[essayProgress.length - 1].value : 0;

            const essayStatus = latestEssay === 1 ? 'Drafting' : (latestEssay === 2 ? 'Finalizing' : 'Not Started');

            if (collegeChartInstance) collegeChartInstance.destroy();

            collegeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Colleges Researched', 'Applications Submitted'],
                    datasets: [{
                        label: 'Count',
                        data: [latestResearched, latestSubmitted],
                        backgroundColor: ['rgba(99, 102, 241, 0.6)', 'rgba(129, 140, 248, 0.6)'],
                        borderColor: ['rgba(99, 102, 241, 1)', 'rgba(129, 140, 248, 1)'],
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: `Current Essay Status: ${essayStatus}` }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { color: '#e2e8f0' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        document.getElementById('sat-subject-selector').addEventListener('change', (e) => renderSatChart(e.target.value));
        document.getElementById('act-subject-selector').addEventListener('change', (e) => renderActChart(e.target.value));

        renderSatChart();
        renderActChart();
        renderCollegeChart();
        });
    </script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>AOS.init({ once: true, duration: 800 });</script>
</body>

</html>