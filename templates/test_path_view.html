<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Your Test Prep Path â€“ Mentics</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Lalezar&display=swap"
        rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


    <style>
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(129, 140, 248, 0.4);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(129, 140, 248, 0.6);
        }

        #chat-history {
            scroll-behavior: smooth;
        }

        .task-node {
            transform: scale(0);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
        }

        .task-node.visible {
            transform: scale(1);
            opacity: 1;
        }

        .dash-segment {
            opacity: 0;
        }

        .dash-segment.animate-in {
            animation: pop-in 0.2s ease forwards;
        }

        @keyframes pop-in {
            from {
                opacity: 0;
                transform: scale(0.5);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
        }
    </style>
</head>

<body class="bg-slate-50 font-sans text-slate-800 antialiased">

    <div class="background-shapes">
        <div class="shape-1"></div>
        <div class="shape-2"></div>
    </div>

    <header class="top-nav">
        <div class="flex justify-between items-center">
            <a href="/" class="text-3xl font-bold text-purple-600 tracking-tight font-lalezar">MENTICS</a>
            <nav class="flex items-center space-x-2">
                <a href="/dashboard" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                    </svg>
                    <span>Dashboard</span>
                </a>
                <a href="/dashboard/stats" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" />
                        <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" />
                    </svg>
                    <span>Stats</span>
                </a>
                <a href="/dashboard/tracker" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V4a1 1 0 011-1zm10 8a1 1 0 011-1h3a1 1 0 011 1v4a1 1 0 01-1 1h-3a1 1 0 01-1-1v-4zm-7 1a1 1 0 011-1h2a1 1 0 011 1v3a1 1 0 01-1 1H8a1 1 0 01-1-1v-3z"
                            clip-rule="evenodd" />
                    </svg>
                    <span>Tracker</span>
                </a>
                <a href="/leaderboard" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                            clip-rule="evenodd" />
                    </svg>
                    <span>Leaderboard</span>
                </a>
                <a href="/forum" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.293 2.293a1 1 0 011.414 0L10 11.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" />
                    </svg>
                    <span>Forum</span>
                </a>
                <a href="/account" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                            clip-rule="evenodd" />
                    </svg>
                    <span>Account</span>
                </a>
            </nav>
            <a href="/logout" class="nav-item !text-red-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z"
                        clip-rule="evenodd" />
                </svg>
                <span>Logout</span>
            </a>
        </div>
    </header>

    <main class="p-6 lg:p-8 w-full">
        <div class="grid grid-cols-1 xl:grid-cols-5 gap-8 h-full">
            <div class="xl:col-span-2 card p-6 flex flex-col h-[calc(100vh-120px)]" data-aos="fade-right">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-slate-900 font-lalezar">AI Assistant</h2>
                    <button id="reset-chat-btn" title="Reset Chat History"
                        class="flex items-center gap-2 text-sm text-slate-500 font-semibold hover:text-red-600 transition-colors py-1 px-3 rounded-lg hover:bg-red-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-red-500">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                            <path fill-rule="evenodd"
                                d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-1.157.06-2.185.44-3.094 1.1a.75.75 0 0 0 .537 1.344C4.1 6.1 4.9 5.75 6 5.75v9.5c-1.1 0-1.9.35-2.557.89a.75.75 0 0 0 .537 1.344c.91-.66 1.936-1.034 3.094-1.1v.443A2.75 2.75 0 0 0 8.75 19h2.5A2.75 2.75 0 0 0 14 16.25v-12.5A2.75 2.75 0 0 0 11.25 1h-2.5ZM7.5 3.75a1.25 1.25 0 0 1 1.25-1.25h2.5a1.25 1.25 0 0 1 1.25 1.25v12.5a1.25 1.25 0 0 1-1.25-1.25h-2.5a1.25 1.25 0 0 1-1.25-1.25v-12.5Z"
                                clip-rule="evenodd" />
                        </svg>
                        Reset Chat
                    </button>
                </div>
                <div id="chat-history" class="flex-grow overflow-y-auto space-y-4 pr-2 -mr-2"></div>
                <div class="mt-4 flex items-center gap-2 pt-4 border-t border-slate-200/80">
                    <input type="text" id="userInput" placeholder="Ask a question..."
                        class="w-full bg-white/50 border border-slate-300/70 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition disabled:bg-slate-100"
                        disabled>
                    <button id="send-btn"
                        class="bg-purple-600 text-white p-2.5 rounded-lg hover:bg-purple-700 font-semibold transition disabled:bg-slate-400 focus:outline-none focus-visible:ring-2 focus-visible:ring-purple-500 focus-visible:ring-offset-2"
                        disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path
                                d="M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="xl:col-span-3 card p-6 relative flex flex-col overflow-hidden h-[calc(100vh-120px)]"
                data-aos="fade-left" data-aos-delay="100">

                <div id="ai-loader-overlay">
                    <div class="loader"></div>
                    <p id="loader-text" class="text-purple-700 font-semibold text-lg mt-6"></p>
                </div>

                <h1 class="text-3xl font-bold font-lalezar text-purple-700 mb-1">Your Personalized Path</h1>
                <p class="text-slate-600 mb-6">Complete each task to move to the next step. Click a node for
                    details.</p>

                <div class="relative flex-grow mb-4 min-h-0 overflow-y-auto">
                    <div class="relative">
                        <svg id="path-svg" class="absolute top-0 left-0 w-full h-full z-0">
                        </svg>
                        <div id="path-nodes-container" class="space-y-10 relative z-10 p-4"></div>
                    </div>
                </div>

                <div class="mt-auto pt-6 border-t border-slate-200/80 flex justify-between items-center">
                    <button onclick="openAddTaskModal()"
                        class="bg-slate-200 text-slate-700 px-5 py-2.5 rounded-lg hover:bg-slate-300 font-semibold transition shadow-sm hover:shadow-md transform hover:-translate-y-0.5 focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-400 focus-visible:ring-offset-2">
                        Add Custom Task
                    </button>
                    <a href="{{ url_for('test_path_builder') }}"
                        class="bg-purple-600 text-white px-5 py-2.5 rounded-lg hover:bg-purple-700 font-semibold transition shadow-md hover:shadow-lg transform hover:-translate-y-0.5 focus:outline-none focus-visible:ring-2 focus-visible:ring-purple-500 focus-visible:ring-offset-2">
                        Edit Path Goals
                    </a>
                </div>
            </div>
        </div>
    </main>

    <div id="taskModal"
        class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4"
        aria-labelledby="modal-title-task" role="dialog" aria-modal="true">
        <div id="modal-panel"
            class="bg-white/60 backdrop-blur-xl border border-white/20 w-full max-w-lg rounded-2xl shadow-2xl p-6 md:p-8"
            data-aos="zoom-in" data-aos-duration="400">
            <div class="flex justify-between items-start">
                <div>
                    <h3 id="modalTitle" class="text-2xl font-bold font-lalezar text-purple-700 mb-1">Task Details</h3>
                    <p id="modalDueDate" class="text-sm font-semibold text-slate-500 mb-4"></p>
                </div>
                <button onclick="closeTaskModal()"
                    class="text-slate-400 hover:text-slate-600 transition-colors rounded-full p-1 -mt-2 -mr-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-purple-500">
                    <span class="sr-only">Close</span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd"
                            d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z"
                            clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <div id="modalDescription" class="text-slate-700 mb-4 prose prose-sm"></div>
            <div id="modalReason" class="text-slate-700 mb-4 prose prose-sm"></div>

            <div id="subtasks-container" class="mb-6 space-y-2">
                <h4 class="text-sm font-bold text-slate-600">Sub-tasks (Notes)</h4>
                <div id="subtasks-list" class="space-y-1"></div>
                <div class="flex items-center gap-2 mt-2">
                    <input type="text" id="newSubtaskInput" placeholder="Add a new note or sub-task..."
                        class="w-full bg-white/50 border border-slate-300/70 rounded-lg p-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition">
                    <button onclick="handleAddSubtask()"
                        class="bg-purple-500 text-white p-2 rounded-lg hover:bg-purple-600 font-semibold transition text-sm">Add</button>
                </div>
            </div>

            <div id="modal-actions" class="flex justify-between items-center gap-3 pt-4 border-t border-slate-200/80">
                <div>
                    <input type="date" id="task-deadline-picker"
                        class="bg-white/50 border border-slate-300/70 rounded-lg p-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition">
                    <button onclick="handleSetDeadline()"
                        class="text-sm bg-slate-200 text-slate-700 px-3 py-2 rounded-lg hover:bg-slate-300 font-semibold transition">Set
                        Date</button>
                </div>
                <div class="flex gap-3">
                    <button onclick="handleImStuck()"
                        class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition">I'm
                        Stuck</button>
                    <button onclick="handleTaskAction('complete')"
                        class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg transition">Mark
                        as Complete</button>
                </div>
            </div>
        </div>
    </div>

    <div id="quizModal"
        class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
        <div id="quiz-modal-panel"
            class="bg-white/60 backdrop-blur-xl border border-white/20 w-full max-w-2xl rounded-2xl shadow-2xl p-6 md:p-8 relative"
            data-aos="zoom-in" data-aos-duration="400">
            <button onclick="closeQuizModal(false)"
                class="text-slate-400 hover:text-slate-600 transition-colors rounded-full p-1 absolute top-4 right-4 focus:outline-none focus-visible:ring-2 focus-visible:ring-purple-500"
                title="Close quiz">
                <span class="sr-only">Close</span>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path fill-rule="evenodd"
                        d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z"
                        clip-rule="evenodd" />
                </svg>
            </button>
            <div id="quiz-start-screen">
                <h3 id="quizTitle" class="text-3xl font-bold font-lalezar text-purple-700 mb-2 text-center">Quiz Title
                </h3>
                <p id="quizReason" class="text-slate-600 mb-6 text-center"></p>
                <div class="text-center">
                    <p class="text-lg font-semibold">Ready to start your 12-minute Study Sprint?</p>
                    <button onclick="startQuiz()"
                        class="mt-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-8 rounded-lg transition shadow-lg hover:shadow-xl transform hover:-translate-y-1">Start
                        Quiz</button>
                </div>
            </div>

            <div id="quiz-main-screen" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="quizTitleInProgress" class="text-xl font-bold font-lalezar text-purple-700">Quiz In Progress
                    </h3>
                    <div
                        class="flex items-center gap-2 font-semibold text-purple-700 bg-purple-100/80 px-3 py-1 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                                clip-rule="evenodd" />
                        </svg>
                        <span id="sprint-timer">12:00</span>
                    </div>
                </div>

                <div id="quiz-question-container">
                    <p class="text-right text-sm font-semibold text-slate-500 mb-2">Question <span
                            id="question-counter">1</span> of <span id="question-total">5</span></p>
                    <p id="question-text" class="text-lg font-semibold text-slate-800 mb-4"></p>
                    <div id="options-container" class="space-y-3"></div>
                </div>

                <div id="quiz-feedback-container" class="hidden mt-4">
                    <div id="feedback-content" class="p-4 rounded-lg">
                        <h4 id="feedback-title" class="font-bold text-lg"></h4>
                        <p id="feedback-explanation" class="text-sm mt-2"></p>
                    </div>
                    <button id="next-question-btn"
                        class="mt-4 w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2.5 rounded-lg transition">Next
                        Question</button>
                </div>
            </div>

            <div id="quiz-end-screen" class="hidden text-center">
                <h3 class="text-3xl font-bold font-lalezar text-purple-700 mb-2">Quiz Complete!</h3>
                <p class="text-lg">You scored <span id="final-score" class="font-bold"></span>/<span
                        id="total-questions-end" class="font-bold"></span>.</p>
                <div class="mt-6">
                    <button onclick="closeQuizModal(true)"
                        class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-5 rounded-lg transition">Mark
                        Task as Complete</button>
                    <button onclick="closeQuizModal(false)" class="mt-2 text-sm text-slate-600 hover:underline">Review
                        Later</button>
                </div>
            </div>
        </div>
    </div>


    <div id="statEntryModal"
        class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4"
        aria-labelledby="modal-title-stat" role="dialog" aria-modal="true">
        <div id="stat-modal-panel"
            class="bg-white/60 backdrop-blur-xl border border-white/20 w-full max-w-lg rounded-2xl shadow-2xl p-6 md:p-8"
            data-aos="zoom-in" data-aos-duration="400">
            <div class="flex justify-between items-start">
                <h3 id="statModalTitle" class="text-2xl font-bold font-lalezar text-purple-700 mb-2">Update Your
                    Progress</h3>
                <button onclick="closeStatModal()"
                    class="text-slate-400 hover:text-slate-600 transition-colors rounded-full p-1 -mt-2 -mr-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-purple-500">
                    <span class="sr-only">Close</span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd"
                            d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z"
                            clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <p class="text-slate-600 mb-6">Great job on completing a milestone! Please enter your new score below.</p>
            <div class="space-y-4">
                <div>
                    <label id="statModalLabel" for="statValue"
                        class="block text-sm font-semibold text-slate-700 mb-1">New Score</label>
                    <input type="number" id="statValue" name="statValue"
                        class="w-full bg-white/50 border border-slate-300/70 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"
                        placeholder="Enter score...">
                    <input type="hidden" id="statNameToUpdate">
                </div>
                <div id="stat-modal-actions" class="flex justify-end gap-3 pt-2">
                    <button onclick="closeStatModal()"
                        class="text-slate-600 font-semibold px-4 py-2 rounded-lg hover:bg-slate-100 transition">Cancel</button>
                    <button onclick="handleSaveStat()"
                        class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition">Save
                        Score</button>
                </div>
            </div>
        </div>
    </div>

    <div id="addTaskModal"
        class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white/60 backdrop-blur-xl border border-white/20 w-full max-w-lg rounded-2xl shadow-2xl p-6 md:p-8"
            data-aos="zoom-in" data-aos-duration="400">
            <h3 class="text-2xl font-bold font-lalezar text-purple-700 mb-4">Add a Custom Task</h3>
            <div class="space-y-4">
                <div>
                    <label for="customTaskDescription" class="block text-sm font-semibold text-slate-700 mb-1">Task
                        Description</label>
                    <textarea id="customTaskDescription" rows="3"
                        class="w-full bg-white/50 border border-slate-300/70 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition"
                        placeholder="e.g., Practice 20 vocabulary words..."></textarea>
                </div>
                <div>
                    <label for="customTaskDueDate" class="block text-sm font-semibold text-slate-700 mb-1">Due Date
                        (Optional)</label>
                    <input type="date" id="customTaskDueDate"
                        class="w-full bg-white/50 border border-slate-300/70 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition">
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button onclick="closeAddTaskModal()"
                        class="text-slate-600 font-semibold px-4 py-2 rounded-lg hover:bg-slate-100 transition">Cancel</button>
                    <button onclick="handleSaveCustomTask()"
                        class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition">Add
                        Task</button>
                </div>
            </div>
        </div>
    </div>


    <script src="{{ url_for('static', filename='js/prompt.js') }}"></script>
    <script src="{{ url_for('static', filename='js/alert.js') }}"></script>
    <script>
        let currentTasks = [];
        let currentTaskId = null;
        let conversationHistory = [];
        const chatCategory = 'Test Prep';

        let currentQuizData = null;
        let currentQuestionIndex = 0;
        let score = 0;
        let sprintTimerInterval = null;


        const loaderOverlay = document.getElementById('ai-loader-overlay');
        const loaderText = document.getElementById('loader-text');

        function showLoader(message) {
            loaderText.textContent = message;
            loaderOverlay.classList.add('visible');
        }

        function hideLoader() {
            loaderOverlay.classList.remove('visible');
        }

        async function loadChatHistory() {
            try {
                const response = await fetch(`/api/chat_history?category=${chatCategory}`);
                if (response.ok) {
                    const history = await response.json();
                    if (history && history.length > 0) {
                        conversationHistory = history;
                        const chatHistoryDiv = document.getElementById('chat-history');
                        chatHistoryDiv.innerHTML = '';
                        conversationHistory.forEach(msg => appendChatMessage(msg.content, msg.role));
                        document.getElementById('userInput').disabled = false;
                        document.getElementById('send-btn').disabled = false;
                    } else {
                        startInitialChat();
                    }
                } else {
                    startInitialChat();
                }
            } catch (error) {
                console.error("Could not load chat history:", error);
                startInitialChat();
            }
        }

        function startInitialChat() {
            conversationHistory.push({
                role: 'user',
                content: 'INITIAL_MESSAGE'
            });
            handleUserChat();
        }

        async function fetchPath(isRegeneration = false) {
            if (isRegeneration) {
                showLoader('Generating new path...');
            }
            const nodesContainer = document.getElementById('path-nodes-container');
            nodesContainer.innerHTML = `<div class="text-center text-slate-500 p-8">${isRegeneration ? '' : 'Loading your path...'}</div>`;
            try {
                const response = await fetch(`/api/tasks?category=${chatCategory}`, {
                    method: isRegeneration ? 'POST' : 'GET'
                });
                if (!response.ok) throw new Error('Network response was not ok');
                const tasks = await response.json();
                if (Array.isArray(tasks) && tasks.length > 0) {
                    currentTasks = tasks.map((task, index) => ({
                        ...task,
                        client_id: index + 1,
                        status: task.is_completed ? 'complete' : 'pending'
                    }));
                    if (isRegeneration) {
                        setTimeout(() => {
                            hideLoader();
                            renderPathAndConnectors(currentTasks, true);
                        }, 500);
                    } else {
                        renderPathAndConnectors(currentTasks, true);
                    }
                } else {
                    window.location.href = "{{ url_for('test_path_builder') }}";
                }
            } catch (error) {
                console.error('Error fetching path:', error);
                hideLoader();
                nodesContainer.innerHTML = `<div class="text-center p-8"><p class="text-red-500 mb-4">Could not load path.</p><button onclick="fetchPath(true)" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Try Again</button></div>`;
            }
        }

        async function renderPathAndConnectors(tasks, withAnimation = false) {
            const nodesContainer = document.getElementById('path-nodes-container');
            const svgContainer = document.getElementById('path-svg');
            nodesContainer.innerHTML = '';
            svgContainer.innerHTML = '';

            const firstPendingIndex = tasks.findIndex(t => t.status === 'pending');

            tasks.forEach((task, index) => {
                const isCompleted = task.status === 'complete';
                const isUnlocked = index === firstPendingIndex;
                const isLocked = index > firstPendingIndex && firstPendingIndex !== -1;
                const isBossBattle = task.description.startsWith('Boss Battle:');
                const isQuiz = task.task_format === 'quiz';

                const alignmentWrapper = document.createElement('div');
                alignmentWrapper.className = 'flex';
                const positions = ['justify-start', 'justify-center', 'justify-end'];
                alignmentWrapper.classList.add(...positions[index % 3].split(' '));

                const taskButton = document.createElement('button');
                taskButton.id = `task-node-${task.client_id}`;
                taskButton.className = 'task-node w-28 h-28 rounded-full flex flex-col items-center justify-center font-bold text-4xl text-white transition-all duration-300 transform hover:scale-110 focus:outline-none focus-visible:ring-4 focus-visible:ring-offset-2 focus-visible:ring-purple-400 relative';
                taskButton.onclick = () => openModalForTask(task);
                taskButton.disabled = isLocked;

                let contentHTML = '';

                if (isBossBattle) {
                    taskButton.classList.add('bg-red-500', 'shadow-lg', 'shadow-red-400/50');
                    contentHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 4a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>`;
                } else if (isCompleted) {
                    taskButton.classList.add('bg-emerald-500', 'shadow-lg');
                    contentHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10"><path fill-rule="evenodd" d="M19.916 4.626a.75.75 0 0 1 .208 1.04l-9 13.5a.75.75 0 0 1-1.154.114l-6-6a.75.75 0 0 1 1.06-1.06l5.353 5.353 8.493-12.74a.75.75 0 0 1 1.04-.207Z" clip-rule="evenodd" /></svg>`;
                } else if (isUnlocked) {
                    taskButton.classList.add('bg-purple-500', 'shadow-lg', 'shadow-purple-400/50');
                    contentHTML = String(task.client_id);
                } else {
                    taskButton.classList.add('bg-slate-300', 'cursor-not-allowed');
                    contentHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10 text-slate-500"><path fill-rule="evenodd" d="M12 1.5a5.25 5.25 0 0 0-5.25 5.25v3a3 3 0 0 0-3 3v6.75a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3v-6.75a3 3 0 0 0-3-3v-3c0-2.9-2.35-5.25-5.25-5.25Zm3.75 8.25v-3a3.75 3.75 0 1 0-7.5 0v3h7.5Z" clip-rule="evenodd" /></svg>`;
                }

                if (isQuiz) {
                    const quizIcon = `<span class="absolute top-1 right-1 bg-white/30 rounded-full p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg></span>`;
                    taskButton.innerHTML = contentHTML + quizIcon;
                } else {
                    taskButton.innerHTML = contentHTML;
                }


                if (!withAnimation) {
                    taskButton.classList.add('visible');
                    if (isUnlocked) taskButton.classList.add('animate-pulse');
                }

                alignmentWrapper.appendChild(taskButton);
                nodesContainer.appendChild(alignmentWrapper);
            });

            if (withAnimation) {
                const nodeElements = Array.from(nodesContainer.querySelectorAll('.task-node'));
                for (let i = 0; i < nodeElements.length; i++) {
                    const node = nodeElements[i];
                    await new Promise(resolve => setTimeout(resolve, 100));
                    node.classList.add('visible');
                    if (node.classList.contains('bg-purple-500')) {
                        node.classList.add('animate-pulse');
                    }
                    await new Promise(resolve => setTimeout(resolve, 200));
                    if (i < nodeElements.length - 1) {
                        await drawAndAnimateConnector(nodeElements[i], nodeElements[i + 1]);
                    }
                }
            } else {
                redrawAllConnectors();
            }
        }

        async function drawAndAnimateConnector(startNode, endNode) {
            const svg = document.getElementById('path-svg');
            if (!svg || !startNode || !endNode) return;

            const isCollegePath = window.location.pathname.includes('college');
            const strokeColor = isCollegePath ? '#C7D2FE' : '#C7B8F9';

            const containerRect = svg.getBoundingClientRect();
            const startRect = startNode.getBoundingClientRect();
            const endRect = endNode.getBoundingClientRect();

            const startX = startRect.left + startRect.width / 2 - containerRect.left;
            const startY = startRect.top + startRect.height / 2 - containerRect.top;
            const endX = endRect.left + endRect.width / 2 - containerRect.left;
            const endY = endRect.top + endRect.height / 2 - containerRect.top;

            const controlX1 = startX + (endX - startX) * 0.2;
            const controlY1 = startY + (endY - startY) * 0.8;
            const controlX2 = startX + (endX - startX) * 0.8;
            const controlY2 = startY + (endY - startY) * 0.2;

            const pathData = `M ${startX} ${startY} C ${controlX1} ${controlY1}, ${controlX2} ${controlY2}, ${endX} ${endY}`;

            const tempPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            tempPath.setAttribute('d', pathData);
            const totalLength = tempPath.getTotalLength();

            const dashLength = 8;
            const gapLength = 6;
            const patternLength = dashLength + gapLength;
            const dashSegments = [];

            const loopUntil = Math.max(totalLength, patternLength);

            for (let currentLength = 0; currentLength < loopUntil; currentLength += patternLength) {
                const start = tempPath.getPointAtLength(currentLength);
                const end = tempPath.getPointAtLength(Math.min(currentLength + dashLength, totalLength));

                const segment = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                segment.setAttribute('x1', start.x);
                segment.setAttribute('y1', start.y);
                segment.setAttribute('x2', end.x);
                segment.setAttribute('y2', end.y);
                segment.setAttribute('stroke', strokeColor);
                segment.setAttribute('stroke-width', '3');
                segment.setAttribute('stroke-linecap', 'round');
                segment.classList.add('dash-segment');
                segment.style.transformOrigin = `${(start.x + end.x) / 2}px ${(start.y + end.y) / 2}px`;

                svg.appendChild(segment);
                dashSegments.push(segment);
            }

            const delayBetweenDashes = 12;
            for (let i = 0; i < dashSegments.length; i++) {
                const segment = dashSegments[i];
                segment.style.animationDelay = `${i * delayBetweenDashes}ms`;
                segment.classList.add('animate-in');
            }
            const totalAnimationTime = dashSegments.length * delayBetweenDashes + 200;
            await new Promise(resolve => setTimeout(resolve, totalAnimationTime));
        }

        function redrawAllConnectors() {
            const svg = document.getElementById('path-svg');
            const nodes = Array.from(document.querySelectorAll('.task-node.visible'));
            if (!svg || nodes.length < 2) return;

            const isCollegePath = window.location.pathname.includes('college');
            const strokeColor = isCollegePath ? '#C7D2FE' : '#C7B8F9';

            svg.innerHTML = '';
            const containerRect = svg.getBoundingClientRect();

            for (let i = 0; i < nodes.length - 1; i++) {
                const startNode = nodes[i];
                const endNode = nodes[i + 1];
                if (!startNode || !endNode) continue;

                const startRect = startNode.getBoundingClientRect();
                const endRect = endNode.getBoundingClientRect();

                const startX = startRect.left + startRect.width / 2 - containerRect.left;
                const startY = startRect.top + startRect.height / 2 - containerRect.top;
                const endX = endRect.left + endRect.width / 2 - containerRect.left;
                const endY = endRect.top + endRect.height / 2 - containerRect.top;

                const controlX1 = startX + (endX - startX) * 0.2;
                const controlY1 = startY + (endY - startY) * 0.8;
                const controlX2 = startX + (endX - startX) * 0.8;
                const controlY2 = startY + (endY - startY) * 0.2;

                const pathData = `M ${startX} ${startY} C ${controlX1} ${controlY1}, ${controlX2} ${controlY2}, ${endX} ${endY}`;

                const tempPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                tempPath.setAttribute('d', pathData);
                const totalLength = tempPath.getTotalLength();

                const dashLength = 8;
                const gapLength = 6;
                const patternLength = dashLength + gapLength;

                const loopUntil = Math.max(totalLength, patternLength);

                for (let currentLength = 0; currentLength < loopUntil; currentLength += patternLength) {
                    const start = tempPath.getPointAtLength(currentLength);
                    const end = tempPath.getPointAtLength(Math.min(currentLength + dashLength, totalLength));

                    const segment = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    segment.setAttribute('x1', start.x);
                    segment.setAttribute('y1', start.y);
                    segment.setAttribute('x2', end.x);
                    segment.setAttribute('y2', end.y);
                    segment.setAttribute('stroke', strokeColor);
                    segment.setAttribute('stroke-width', '3');
                    segment.setAttribute('stroke-linecap', 'round');
                    svg.appendChild(segment);
                }
            }
        }

        async function openModalForTask(task) {
            currentTaskId = task.id;
            if (task.task_format === 'quiz') {
                try {
                    const response = await fetch(`/api/quiz/${task.id}`);
                    if (!response.ok) throw new Error('Failed to load quiz');
                    currentQuizData = await response.json();
                    currentQuizData.reason = task.reason;
                    openQuizModal();
                } catch (error) {
                    console.error("Error fetching quiz:", error);
                    alert("Could not load the quiz. Please try again.");
                }
            } else {
                openTaskModal(task);
            }
        }

        function openTaskModal(task) {
            const modal = document.getElementById('taskModal');
            document.getElementById('modalTitle').textContent = `Step ${task.client_id}: Your Task`;

            document.getElementById('modalDescription').innerHTML = marked.parse(task.description);
            document.getElementById('modalReason').innerHTML = `<b>Why:</b> ${marked.parse(task.reason)}`;


            const dueDateEl = document.getElementById('modalDueDate');
            const deadlinePicker = document.getElementById('task-deadline-picker');
            if (task.due_date) {
                dueDateEl.textContent = `Due: ${new Date(task.due_date + 'T00:00:00').toLocaleDateString()}`;
                deadlinePicker.value = task.due_date;
            } else {
                dueDateEl.textContent = 'No due date set';
                deadlinePicker.value = '';
            }

            renderSubtasks(task.subtasks || []);

            modal.classList.remove('hidden');
        }

        function openQuizModal() {
            currentQuestionIndex = 0;
            score = 0;

            document.getElementById('quizTitle').textContent = currentQuizData.title;
            document.getElementById('quizReason').textContent = currentQuizData.reason;
            document.getElementById('quiz-start-screen').classList.remove('hidden');
            document.getElementById('quiz-main-screen').classList.add('hidden');
            document.getElementById('quiz-end-screen').classList.add('hidden');
            document.getElementById('quizModal').classList.remove('hidden');
        }

        function startQuiz() {
            document.getElementById('quiz-start-screen').classList.add('hidden');
            document.getElementById('quiz-main-screen').classList.remove('hidden');
            document.getElementById('quizTitleInProgress').textContent = currentQuizData.title;

            displayQuestion();
            startSprintTimer(12 * 60);
        }

        function displayQuestion() {
            const question = currentQuizData.questions[currentQuestionIndex];
            document.getElementById('question-counter').textContent = currentQuestionIndex + 1;
            document.getElementById('question-total').textContent = currentQuizData.questions.length;
            document.getElementById('question-text').textContent = question.question_text;

            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'w-full text-left p-3 border-2 border-slate-300/70 rounded-lg hover:bg-purple-100/50 hover:border-purple-400 transition';
                button.onclick = () => selectAnswer(index, button);
                optionsContainer.appendChild(button);
            });

            document.getElementById('quiz-feedback-container').classList.add('hidden');
        }

        function selectAnswer(selectedIndex, button) {
            document.querySelectorAll('#options-container button').forEach(btn => btn.disabled = true);

            const question = currentQuizData.questions[currentQuestionIndex];
            const isCorrect = selectedIndex === question.correct_option;

            const feedbackContent = document.getElementById('feedback-content');
            const feedbackTitle = document.getElementById('feedback-title');
            const feedbackExplanation = document.getElementById('feedback-explanation');

            if (isCorrect) {
                score++;
                button.classList.remove('border-slate-300/70');
                button.classList.add('border-emerald-500', 'bg-emerald-100/50');
                feedbackContent.className = 'p-4 rounded-lg bg-emerald-100/70 border border-emerald-300/80';
                feedbackTitle.textContent = "Correct!";
                feedbackTitle.className = "font-bold text-lg text-emerald-800";
            } else {
                button.classList.remove('border-slate-300/70');
                button.classList.add('border-red-500', 'bg-red-100/50');
                document.querySelectorAll('#options-container button')[question.correct_option].classList.add('border-emerald-500', 'bg-emerald-100/50');
                feedbackContent.className = 'p-4 rounded-lg bg-red-100/70 border border-red-300/80';
                feedbackTitle.textContent = "Not quite!";
                feedbackTitle.className = "font-bold text-lg text-red-800";
            }

            feedbackExplanation.textContent = question.explanation;
            document.getElementById('quiz-feedback-container').classList.remove('hidden');
        }

        document.getElementById('next-question-btn').addEventListener('click', () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuizData.questions.length) {
                displayQuestion();
            } else {
                showEndScreen();
            }
        });

        function showEndScreen() {
            document.getElementById('quiz-main-screen').classList.add('hidden');
            document.getElementById('quiz-end-screen').classList.remove('hidden');
            document.getElementById('final-score').textContent = score;
            document.getElementById('total-questions-end').textContent = currentQuizData.questions.length;
            stopSprintTimer();
        }

        function closeQuizModal(markComplete = false) {
            document.getElementById('quizModal').classList.add('hidden');
            stopSprintTimer();
            const timerEl = document.getElementById('sprint-timer');
            if (timerEl) timerEl.textContent = '';
            const startScreen = document.getElementById('quiz-start-screen');
            const mainScreen = document.getElementById('quiz-main-screen');
            const endScreen = document.getElementById('quiz-end-screen');
            if (startScreen) startScreen.classList.remove('hidden');
            if (mainScreen) mainScreen.classList.add('hidden');
            if (endScreen) endScreen.classList.add('hidden');

            if (markComplete) {
                handleTaskAction('complete');
            }
        }

        function startSprintTimer(duration) {
            let timer = duration, minutes, seconds;
            const timerEl = document.getElementById('sprint-timer');

            sprintTimerInterval = setInterval(() => {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                timerEl.textContent = minutes + ":" + seconds;

                if (--timer < 0) {
                    stopSprintTimer();
                    timerEl.textContent = "Time's up!";
                    showEndScreen();
                }
            }, 1000);
        }

        function stopSprintTimer() {
            clearInterval(sprintTimerInterval);
        }


        function renderSubtasks(subtasks) {
            const subtasksList = document.getElementById('subtasks-list');
            subtasksList.innerHTML = '';
            if (subtasks.length === 0) {
                subtasksList.innerHTML = '<p class="text-sm text-slate-500">No notes or sub-tasks yet.</p>';
                return;
            }
            subtasks.forEach(subtask => {
                const item = document.createElement('div');
                item.className = 'subtask-item';
                item.innerHTML = `
                    <input type="checkbox" id="subtask-${subtask.id}" onchange="handleToggleSubtask(${subtask.id}, this.checked)" ${subtask.is_completed ? 'checked' : ''} class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500">
                    <label for="subtask-${subtask.id}" class="text-sm text-slate-700 ${subtask.is_completed ? 'line-through text-slate-500' : ''}">${subtask.description}</label>
                `;
                subtasksList.appendChild(item);
            });
        }

        async function handleAddSubtask() {
            const input = document.getElementById('newSubtaskInput');
            const description = input.value.trim();
            if (!description) return;

            const response = await fetch('/api/add_subtask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ parent_task_id: currentTaskId, description })
            });
            const result = await response.json();
            if (result.success) {
                const task = currentTasks.find(t => t.id === currentTaskId);
                if (!task.subtasks) task.subtasks = [];
                task.subtasks.push(result.subtask);
                renderSubtasks(task.subtasks);
                input.value = '';
            }
        }

        async function handleToggleSubtask(subtaskId, is_completed) {
            await fetch('/api/update_subtask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ subtaskId, is_completed })
            });
            const task = currentTasks.find(t => t.id === currentTaskId);
            const subtask = task.subtasks.find(s => s.id === subtaskId);
            subtask.is_completed = is_completed;
            renderSubtasks(task.subtasks);
        }

        async function handleSetDeadline() {
            const picker = document.getElementById('task-deadline-picker');
            const dueDate = picker.value;
            await fetch('/api/update_task_deadline', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ taskId: currentTaskId, dueDate })
            });
            const task = currentTasks.find(t => t.id === currentTaskId);
            task.due_date = dueDate;
            document.getElementById('modalDueDate').textContent = `Due: ${new Date(dueDate + 'T00:00:00').toLocaleDateString()}`;
            alert('Deadline updated!');
        }

        function closeTaskModal() {
            document.getElementById('taskModal').classList.add('hidden');
        }

        function closeStatModal() {
            document.getElementById('statEntryModal').classList.add('hidden');
        }

        function openAddTaskModal() {
            document.getElementById('addTaskModal').classList.remove('hidden');
        }

        function closeAddTaskModal() {
            document.getElementById('addTaskModal').classList.add('hidden');
            document.getElementById('customTaskDescription').value = '';
            document.getElementById('customTaskDueDate').value = '';
        }

        async function handleSaveCustomTask() {
            const description = document.getElementById('customTaskDescription').value.trim();
            const dueDate = document.getElementById('customTaskDueDate').value;
            if (!description) {
                alert('Please enter a task description.');
                return;
            }

            const response = await fetch('/api/add_task', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ description, category: chatCategory, due_date: dueDate })
            });
            const result = await response.json();
            if (result.success) {
                currentTasks.push(result.task);
                renderPathAndConnectors(currentTasks, false);
                closeAddTaskModal();
            } else {
                alert('Could not add task. Please try again.');
            }
        }

        async function handleImStuck() {
            const task = currentTasks.find(t => t.id === currentTaskId);
            if (!task) return;
            closeTaskModal();
            const reason = await prompt(`You're working on the task:\n"${task.description}"`, '',
                'What part is giving you trouble?');
            if (reason && reason.trim() !== "") {
                const chatInput = document.getElementById('userInput');
                chatInput.value =
                    `I'm having trouble with the task: "${task.description}". Specifically, my problem is: ${reason}`;
                handleUserChat();
                chatInput.focus();
            }
        }

        async function handleTaskAction(status) {
            const task = currentTasks.find(t => t.id === currentTaskId);
            if (!task) return;
            closeTaskModal();
            try {
                const response = await fetch('/api/update_task_status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        taskId: task.id,
                        status: status
                    })
                });
                if (!response.ok) throw new Error('Could not update task status');
                const result = await response.json();
                if (status === 'complete') {
                    const taskIndex = currentTasks.findIndex(t => t.id === currentTaskId);
                    if (taskIndex !== -1) currentTasks[taskIndex].status = 'complete';
                    renderPathAndConnectors(currentTasks, false);
                    if (task.type === 'milestone' && task.stat_to_update) {
                        setTimeout(() => openStatModal(task), 500);
                    } else {
                        await checkPathCompletion();
                    }
                }
            } catch (error) {
                console.error("Error updating task status:", error);
                alert("Could not update task. Please try again.");
            }
        }

        async function checkPathCompletion() {
            const allComplete = currentTasks.every(t => t.status === 'complete');
            if (allComplete && currentTasks.length > 0) {
                setTimeout(async () => {
                    alert("Great job! Generating your next set of challenges.");
                    await fetchPath(true);
                }, 500);
            }
        }


        function openStatModal(task) {
            const statName = task.stat_to_update;
            const modal = document.getElementById('statEntryModal');
            const modalTitle = document.getElementById('statModalTitle');
            const modalLabel = document.getElementById('statModalLabel');
            const statValueInput = document.getElementById('statValue');
            const statNameToUpdate = document.getElementById('statNameToUpdate');
            const p = modal.querySelector('p');

            const statDetails = {
                "sat_math": {
                    name: "New SAT Math Score",
                    placeholder: "Enter score (200-800)",
                    min: 200,
                    max: 800
                },
                "sat_ebrw": {
                    name: "New SAT EBRW Score",
                    placeholder: "Enter score (200-800)",
                    min: 200,
                    max: 800
                },
                "sat_total": {
                    name: "Full SAT Practice Score",
                    placeholder: "Enter total score (400-1600)",
                    min: 400,
                    max: 1600
                },
                "act_math": {
                    name: "New ACT Math Score",
                    placeholder: "Enter score (1-36)",
                    min: 1,
                    max: 36
                },
                "act_reading": {
                    name: "New ACT Reading Score",
                    placeholder: "Enter score (1-36)",
                    min: 1,
                    max: 36
                },
                "act_science": {
                    name: "New ACT Science Score",
                    placeholder: "Enter score (1-36)",
                    min: 1,
                    max: 36
                },
                "act_composite": {
                    name: "Full ACT Practice Score",
                    placeholder: "Enter composite score (1-36)",
                    min: 1,
                    max: 36
                }
            };

            const details = statDetails[statName] || {
                name: "Update Score",
                placeholder: "Enter value"
            };

            modalTitle.textContent = `Update: ${details.name}`;
            modalLabel.textContent = details.name;
            statValueInput.placeholder = details.placeholder;
            statValueInput.min = details.min || "";
            statValueInput.max = details.max || "";
            statNameToUpdate.value = statName;
            statValueInput.value = "";

            if (statName === 'sat_total' || statName === 'act_composite') {
                p.innerHTML =
                    `This practice score will <strong>not</strong> be saved to your main Stats page. It will only be used on the <a href="/dashboard/tracker" class="text-purple-600 hover:underline font-semibold">Tracker</a> page to chart your progress and help improve future paths.`;
            } else {
                p.innerHTML =
                    `Great job on this milestone! The score you enter will be saved to your <a href="/dashboard/stats" class="text-purple-600 hover:underline font-semibold">Stats</a> page and will help tailor your future test prep paths.`;
            }

            modal.classList.remove('hidden');
        }

        async function handleSaveStat() {
            const statValueInput = document.getElementById('statValue');
            const stat_name = document.getElementById('statNameToUpdate').value;
            const stat_value = statValueInput.value;

            if (!stat_value) {
                alert("Please enter a value.");
                return;
            }

            const valueNum = parseFloat(stat_value);
            const min = parseFloat(statValueInput.min);
            const max = parseFloat(statValueInput.max);

            if (!isNaN(min) && valueNum < min) {
                alert(`The score cannot be less than ${min}. Please enter a valid score.`);
                return;
            }
            if (!isNaN(max) && valueNum > max) {
                alert(`The score cannot be greater than ${max}. Please enter a valid score.`);
                return;
            }

            try {
                const response = await fetch('/api/update_stats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        stat_name,
                        stat_value
                    })
                });
                if (!response.ok) throw new Error('Failed to save stats.');
                const result = await response.json();
                if (result.success) {
                    alert("Your stats have been updated!");
                    closeStatModal();
                    await checkPathCompletion();
                } else {
                    throw new Error(result.error || 'An unknown error occurred.');
                }
            } catch (error) {
                console.error("Error saving stat:", error);
                alert("Could not save your stats. Please try again.");
            }
        }

        async function handleUserChat() {
            const chatInput = document.getElementById('userInput');
            const sendButton = document.getElementById('send-btn');
            let message = chatInput.value.trim();
            const isInitialMessage = conversationHistory.length > 0 && conversationHistory[conversationHistory
                .length - 1].content === 'INITIAL_MESSAGE';

            if (isInitialMessage) {
                chatInput.value = "";
            } else if (message === "") {
                return;
            }

            const userMessageLower = message.toLowerCase();
            const isRegenRequest = userMessageLower.includes('regenerate') || userMessageLower.includes('new path');


            if (!isInitialMessage) {
                appendChatMessage(message, 'user');
                conversationHistory.push({
                    role: 'user',
                    content: message
                });
            }

            chatInput.value = "";
            chatInput.disabled = true;
            sendButton.disabled = true;

            if (isRegenRequest) {
                showLoader('AI is regenerating your path...');
            }

            const typingIndicator = appendChatMessage('...', 'bot', true);

            try {
                const response = await fetch(`/api/chat?category=${chatCategory}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        history: conversationHistory
                    })
                });
                if (!response.ok) throw new Error('AI response error.');

                const data = await response.json();
                typingIndicator.remove();

                if (isInitialMessage) {
                    conversationHistory = [];
                }

                if (data.new_path) {
                    appendChatMessage("I've generated a new path for you based on our conversation.", 'bot');
                    conversationHistory.push({
                        role: 'assistant',
                        content: "I've generated a new path for you based on our conversation."
                    });
                    currentTasks = data.new_path.map((task, index) => ({
                        ...task,
                        client_id: index + 1,
                        status: task.is_completed ? 'complete' : 'pending'
                    }));
                    hideLoader();
                    renderPathAndConnectors(currentTasks, true);

                } else {
                    const aiReply = data.reply;
                    appendChatMessage(aiReply, 'bot');
                    conversationHistory.push({
                        role: 'assistant',
                        content: aiReply
                    });
                }

            } catch (error) {
                typingIndicator.querySelector('p').textContent = "Sorry, I'm having trouble connecting.";
                console.error("Chat error:", error);
                if (isRegenRequest) hideLoader();
            } finally {
                chatInput.disabled = false;
                sendButton.disabled = false;
                chatInput.focus();
            }
        }

        async function handleResetChat() {
            if (confirm("Are you sure you want to reset your chat history? This cannot be undone.")) {
                try {
                    const response = await fetch('/api/reset_chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            category: chatCategory
                        })
                    });
                    if (!response.ok) throw new Error('Failed to reset chat.');

                    document.getElementById('chat-history').innerHTML = '';
                    conversationHistory = [];
                    startInitialChat();
                } catch (error) {
                    console.error("Error resetting chat:", error);
                    alert("Could not reset chat history. Please try again.");
                }
            }
        }

        function appendChatMessage(text, role, isTyping = false) {
            const chatHistory = document.getElementById('chat-history');
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'flex ' + (role === 'user' ? 'justify-end' : 'justify-start');
            const messageDiv = document.createElement('div');
            let cssClass = 'p-3 rounded-xl max-w-xs text-sm prose prose-sm';
            if (role === 'user') {
                cssClass += ' bg-purple-600 text-white';
            } else {
                cssClass += ' bg-white/80 text-slate-700';
                if (isTyping) cssClass += ' animate-pulse';
            }
            messageDiv.className = cssClass;

            messageDiv.innerHTML = marked.parse(text);

            messageWrapper.appendChild(messageDiv);
            chatHistory.appendChild(messageWrapper);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return messageWrapper;
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- START OF THE FIX ---
            localStorage.setItem('hasTestPath', 'true');
            // --- END OF THE FIX ---
            fetchPath();
            loadChatHistory();
        });
        window.addEventListener('resize', () => redrawAllConnectors());
        document.getElementById('send-btn').addEventListener('click', handleUserChat);
        document.getElementById('userInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleUserChat();
        });
        document.getElementById('reset-chat-btn').addEventListener('click', handleResetChat);
    </script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init({
            once: true,
            duration: 800
        });
    </script>
    <footer class="text-center p-8 text-sm text-slate-500">
        <p>
            <span>&copy; 2025 Mentics. All Rights Reserved.</span>
            <span class="mx-2">|</span>
            <a href="{{ url_for('terms') }}" class="hover:text-purple-600 hover:underline">Terms of Service</a>
            <span class="mx-2">|</span>
            <a href="{{ url_for('privacy') }}" class="hover:text-purple-600 hover:underline">Privacy Policy</a>
        </p>
    </footer>
</body>

</html>